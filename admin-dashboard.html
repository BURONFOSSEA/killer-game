<!DOCTYPE html>
      background: #f5576c;
      color: white;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 5px;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <script>
    if (localStorage.getItem('isAdmin') !== 'true') {
      window.location.href = 'admin-login.html';
    }
  </script>
  <div class="header">
    <h1>ğŸ¯ Admin Dashboard - Killer Game</h1>
    <p>GÃ©rez vos parties et joueurs</p>
  </div>
  <div class="nav">
    <button onclick="showSection('inscriptions',this)" class="active">ğŸ“ Inscriptions</button>
    <button onclick="showSection('joueurs',this)">ğŸ‘¥ Joueurs</button>
    <button onclick="showSection('parties',this)">ğŸ® Parties</button>
    <button onclick="showSection('defis',this)">ğŸ’¡ DÃ©fis</button>
    <button onclick="showSection('kills',this)">âš”ï¸ Kills</button>
  </div>
  <div class="content">
    <div id="inscriptions" class="section active">
      <h2>ğŸ“ Inscriptions en attente</h2>
      <div id="inscriptionsTable"></div>
    </div>
    <div id="joueurs" class="section">
      <h2>ğŸ‘¥ Liste des joueurs validÃ©s</h2>
      <div id="joueursTable"></div>
    </div>
    <div id="parties" class="section">
      <h2>ğŸ® Gestion des parties</h2>
      <div style="margin-bottom: 30px;">
        <h3>CrÃ©er une nouvelle partie</h3>
        <div class="form-group">
          <label>Nom de la partie</label>
          <input type="text" id="nomPartie" placeholder="Ex: Partie de NoÃ«l 2024">
        </div>
        <button class="btn btn-primary" onclick="creerPartie()">CrÃ©er la partie</button>
      </div>
      <div id="partiesTable"></div>
    </div>
    <div id="defis" class="section">
      <h2>ğŸ’¡ Gestion des dÃ©fis</h2>
      <div style="margin-bottom: 30px;">
        <h3>Ajouter un nouveau dÃ©fi</h3>
        <div class="form-group">
          <label>Description du dÃ©fi</label>
          <input type="text" id="nouveauDefi" placeholder="Ex: Faire un high-five Ã  votre cible">
        </div>
        <button class="btn btn-primary" onclick="ajouterDefi()">Ajouter le dÃ©fi</button>
      </div>
      <div id="defisTable"></div>
    </div>
    <div id="kills" class="section">
      <h2>âš”ï¸ Kills contestÃ©s</h2>
      <div id="killsTable"></div>
    </div>
  </div>
    <div id="modalConfig" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000;">
        statut_global: 'actif'
      });
      await supabaseUpdate('inscriptions_attente', { statut: 'valide' }, `?id=eq.${id}`);
      alert('âœ… Joueur validÃ© !');
      chargerInscriptions();
    }

    async function refuserInscription(id) {
      await supabaseUpdate('inscriptions_attente', { statut: 'refuse' }, `?id=eq.${id}`);
      alert('âŒ Inscription refusÃ©e');
      chargerInscriptions();
    }

    async function chargerJoueurs() {
      const joueurs = await supabaseSelect('joueurs');
      let html = '<table><tr><th>Nom</th><th>PrÃ©nom</th><th>Pseudo</th><th>TÃ©lÃ©phone</th><th>Statut</th></tr>';
      joueurs.forEach(joueur => {
        html += `
          <tr>
            <td>${joueur.nom}</td>
            <td>${joueur.prenom}</td>
            <td>${joueur.pseudo}</td>
            <td>${joueur.telephone}</td>
            <td>${joueur.statut_global}</td>
          </tr>
        `;
      });
      html += '</table>';
      document.getElementById('joueursTable').innerHTML = html;
    }

    async function creerPartie() {
      const nomPartie = document.getElementById('nomPartie').value;
      if (!nomPartie) {
        alert('âš ï¸ Veuillez entrer un nom de partie');
        return;
      }
      await supabaseInsert('parties', {
        nom_partie: nomPartie,
        statut: 'creee'
      });
      alert('âœ… Partie crÃ©Ã©e !');
      document.getElementById('nomPartie').value = '';
      chargerParties();
    }

    async function chargerParties() {
      const parties = await supabaseSelect('parties');
      let html = '<table><tr><th>Nom de la partie</th><th>Statut</th><th>Date</th><th>Actions</th></tr>';
      parties.forEach(partie => {
        html += `
          <tr>
            <td>${partie.nom_partie}</td>
            <td>
              ${partie.statut === 'terminee' ?
                '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:12px;">ğŸ† TerminÃ©e</span>' :
                partie.statut
              }
            </td>
            <td>${new Date(partie.created_at).toLocaleDateString('fr-FR')}</td>
            <td>
              ${partie.statut === 'creee' ? `<button class="btn btn-primary" onclick="configurerPartie('${partie.id}')">âš™ï¸ Configurer</button>` : ''}
              ${partie.statut === 'lancee' || partie.statut === 'terminee' ? `<button class="btn btn-success" onclick="voirDetailsPartie('${partie.id}', '${partie.nom_partie}')">ğŸ‘ï¸ Voir dÃ©tails</button>` : ''}
            </td>
          </tr>
        `;
      });
      html += '</table>';
      document.getElementById('partiesTable').innerHTML = html;
    }
                  async function ajouterDefi() {
        return;
      }
      let joueursMelanges = [...joueursSelectionnes].sort(() => Math.random() - 0.5);
      const defis = await supabaseSelect('defis');
      boucleGeneree = [];
      for (let i = 0; i < joueursMelanges.length; i++) {
        const tueur = joueursMelanges[i];
        const cible = joueursMelanges[(i + 1) % joueursMelanges.length];
        const defi = defis[Math.floor(Math.random() * defis.length)];
        boucleGeneree.push({
          tueur,
          cible,
          defi
        });
      }
      let html = '<table><tr><th>Tueur</th><th>â†’</th><th>Cible</th><th>DÃ©fi</th></tr>';
      boucleGeneree.forEach(item => {
        html += `
          <tr>
            <td>${item.tueur.pseudo}</td>
            <td>â†’</td>
            <td>${item.cible.pseudo}</td>
            <td>${item.defi.description}</td>
          </tr>
        `;
      });
      html += '</table>';
      document.getElementById('affichageBoucle').innerHTML = html;
      document.getElementById('boucleSection').style.display = 'block';
    }

    async function lancerPartie() {
      if (!confirm('ğŸš€ ÃŠtes-vous sÃ»r de vouloir lancer la partie ? Les joueurs recevront leurs cibles.')) {
        return;
      }
      try {
        for (const item of boucleGeneree) {
          await supabaseInsert('parties_joueurs', {
            id_partie: partieEnCours,
            id_joueur: item.tueur.id,
            id_tueur: null,
            id_cible: item.cible.id,
            id_defi: item.defi.id,
            statut_joueur: 'vivant'
          });
        }
        await supabaseUpdate('parties',
          { statut: 'lancee' },
          `?id=eq.${partieEnCours}`
        );
        alert('âœ… Partie lancÃ©e avec succÃ¨s ! Les joueurs peuvent maintenant se connecter.');
        fermerModal();
        chargerParties();
      } catch (error) {
        console.error('Erreur:', error);
        alert('âŒ Erreur lors du lancement de la partie');
      }
    }

    function fermerModal() {
      document.getElementById('modalConfig').style.display = 'none';
      partieEnCours = null;
      joueursSelectionnes = [];
      boucleGeneree = [];
    }
                    async function voirDetailsPartie(idPartie, nomPartie) {
                    <th style="padding:8px;">Statut</th>
                  </tr>
          `;
          joueurData.kills.forEach(kill => {
            const statutBadge = kill.statut === 'valide' ?
              '<span style="background:#007bff;color:white;padding:2px 6px;border-radius:8px;font-size:11px;">Admin</span>' :
              '<span style="background:#28a745;color:white;padding:2px 6px;border-radius:8px;font-size:11px;">AcceptÃ©</span>';
            html += `
              <tr>
                <td style="padding:8px;">${kill.cible} <small style="color:#666;">(${kill.cibleNomComplet})</small></td>
                <td style="padding:8px;"><small>${kill.defi}</small></td>
                <td style="padding:8px;"><small>${kill.date}</small></td>
                <td style="padding:8px;">${statutBadge}</td>
              </tr>
            `;
          });
          html += `
                </table>
              </div>
            </div>
          `;
        });
        document.getElementById('historiqueKillsDetails').innerHTML = html;
      } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('historiqueKillsDetails').innerHTML =
          '<p style="color:red;">Erreur lors du chargement de l\'historique des kills</p>';
      }
    }

    async function validerKillDepuisDetails(idKill, idPartie) {
      await validerKill(idKill);
      await chargerKillsEnAttentePartie(idPartie);
      await chargerBouclePartie(idPartie);
      await chargerHistoriqueKills(idPartie);
    }

    async function invaliderKillDepuisDetails(idKill, idPartie) {
      await invaliderKill(idKill);
      await chargerKillsEnAttentePartie(idPartie);
    }

    function fermerModalDetails() {
      document.getElementById('modalDetails').style.display = 'none';
      localStorage.removeItem('adminModalDetailsOpen');
      localStorage.removeItem('adminModalDetailsPartie');
      localStorage.removeItem('adminModalDetailsNom');
    }

    document.addEventListener('DOMContentLoaded', function() {
      const sectionActive = localStorage.getItem('adminActiveSection') || 'inscriptions';
      const boutonActif = document.querySelector(`button[onclick*="${sectionActive}"]`);
      
      if (boutonActif) {
        showSection(sectionActive, boutonActif);
      } else {
        chargerInscriptions();
      }

      const modalOuvert = localStorage.getItem('adminModalDetailsOpen');
      if (modalOuvert === 'true') {
        const idPartie = localStorage.getItem('adminModalDetailsPartie');
        const nomPartie = localStorage.getItem('adminModalDetailsNom');
        if (idPartie && nomPartie) {
          setTimeout(() => {
            voirDetailsPartie(idPartie, nomPartie);
          }, 500);
        }
      }
    });
  </script>
</body>
</html>
