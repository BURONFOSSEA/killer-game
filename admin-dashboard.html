<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Killer Game</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: Arial, sans-serif;
background: #f5f5f5;
}
.header {
background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
color: white;
padding: 20px;
text-align: center;
}
.nav {
background: white;
padding: 15px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
display: flex;
justify-content: center;
gap: 20px;
flex-wrap: wrap;
}
.nav button {
padding: 10px 20px;
border: none;
border-radius: 5px;
background: #f5576c;
color: white;
cursor: pointer;
font-weight: bold;
transition: background 0.3s;
}
.nav button:hover {
background: #e04455;
}
.nav button.active {
background: #333;
}
.content {
max-width: 1200px;
margin: 30px auto;
padding: 0 20px;
}
.section {
display: none;
background: white;
padding: 30px;
border-radius: 10px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.section.active {
display: block;
}
h2 {
color: #f5576c;
margin-bottom: 20px;
}
table {
width: 100%;
border-collapse: collapse;
margin-top: 20px;
}
th, td {
padding: 12px;
text-align: left;
border-bottom: 1px solid #ddd;
}
th {
background: #f5576c;
color: white;
}
tr:hover {
background: #f9f9f9;
}
.btn {
padding: 8px 15px;
border: none;
border-radius: 5px;
cursor: pointer;
font-weight: bold;
margin-right: 5px;
}
.btn-success {
background: #28a745;
color: white;
}
.btn-danger {
background: #dc3545;
color: white;
}
.btn-primary {
background: #007bff;
color: white;
}
.form-group {
margin-bottom: 15px;
}
.form-group label {
display: block;
margin-bottom: 5px;
font-weight: bold;
}
.form-group input, .form-group select {
width: 100%;
padding: 10px;
border: 2px solid #ddd;
border-radius: 5px;
font-size: 16px;
}
</style>
</head>
<body>
<script>
if (localStorage.getItem('isAdmin') !== 'true') {
window.location.href = 'admin-login.html';
}
</script>
<div class="header">
<h1>üéØ Admin Dashboard - Killer Game</h1>
<p>G√©rez vos parties et joueurs</p>
</div>
<div class="nav">
<button onclick="showSection('inscriptions',this)" class="active">üìù Inscriptions</button>
<button onclick="showSection('joueurs',this)">üë• Joueurs</button>
<button onclick="showSection('parties',this)">üéÆ Parties</button>
<button onclick="showSection('defis',this)">üí° D√©fis</button>
<button onclick="showSection('kills',this)">‚öîÔ∏è Kills</button>
</div>
<div class="content">
<div id="inscriptions" class="section active">
<h2>üìù Inscriptions en attente</h2>
<div id="inscriptionsTable"></div>
</div>
<div id="joueurs" class="section">
<h2>üë• Liste des joueurs valid√©s</h2>
<div id="joueursTable"></div>
</div>
<div id="parties" class="section">
<h2>üéÆ Gestion des parties</h2>
<div style="margin-bottom: 30px;">
<h3>Cr√©er une nouvelle partie</h3>
<div class="form-group">
<label>Nom de la partie</label>
<input type="text" id="nomPartie" placeholder="Ex: Partie de No√´l 2024">
</div>
<button class="btn btn-primary" onclick="creerPartie()">Cr√©er la partie</button>
</div>
<div id="partiesTable"></div>
</div>
<div id="defis" class="section">
<h2>üí° Gestion des d√©fis</h2>
<div style="margin-bottom: 30px;">
<h3>Ajouter un nouveau d√©fi</h3>
<div class="form-group">
<label>Description du d√©fi</label>
<input type="text" id="nouveauDefi" placeholder="Ex: Faire un high-five √† votre cible">
</div>
<button class="btn btn-primary" onclick="ajouterDefi()">Ajouter le d√©fi</button>
</div>
<div id="defisTable"></div>
</div>
<div id="kills" class="section">
<h2>‚öîÔ∏è Kills contest√©s</h2>
<div id="killsTable"></div>
</div>
</div>
<div id="modalConfig" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000;">
<div style="background:white; max-width:800px; margin:50px auto; padding:30px; border-radius:10px; max-height:80vh; overflow-y:auto;">
<h2>‚öôÔ∏è Configuration de la partie</h2>
<p id="nomPartieConfig" style="color:#666; margin-bottom:20px;"></p>
<h3>1Ô∏è‚É£ S√©lectionner les joueurs</h3>
<div id="listeJoueursConfig"></div>
<button class="btn btn-primary" onclick="genererBoucle()" style="margin-top:20px;">
üîÑ G√©n√©rer la boucle Tueur/Cible
</button>
<div id="boucleSection" style="display:none; margin-top:30px;">
<h3>2Ô∏è‚É£ Boucle Tueur ‚Üí Cible ‚Üí D√©fi</h3>
<div id="affichageBoucle"></div>
<button class="btn btn-success" onclick="lancerPartie()" style="margin-top:20px;">
üöÄ Lancer la partie !
</button>
</div>
<button class="btn btn-danger" onclick="fermerModal()" style="margin-top:20px;">
‚ùå Fermer
</button>
</div>
</div>
<div id="modalDetails" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000;">
<div style="background:white; max-width:1000px; margin:20px auto; padding:30px; border-radius:10px; max-height:90vh; overflow-y:auto;">
<h2>üëÅÔ∏è D√©tails de la partie</h2>
<p id="nomPartieDetails" style="color:#666; margin-bottom:20px;"></p>
<h3>üîÑ Boucle des joueurs</h3>
<div id="boucleDetails" style="margin-bottom:30px;"></div>
<h3>‚öîÔ∏è Kills en attente de validation</h3>
<div id="killsEnAttenteDetails" style="margin-bottom:30px;"></div>
<h3>üìú Historique des kills r√©ussis</h3>
<div id="historiqueKillsDetails" style="margin-bottom:30px;"></div>
<button class="btn btn-danger" onclick="fermerModalDetails()" style="margin-top:20px;">
‚ùå Fermer
</button>
</div>
</div>
<script src="supabaseClient.js"></script>
<script>
function showSection(sectionName,element) {
// Sauvegarder la section active
localStorage.setItem('adminActiveSection', sectionName);
document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
document.getElementById(sectionName).classList.add('active');
element.classList.add('active');
if (sectionName === 'inscriptions') chargerInscriptions();
if (sectionName === 'joueurs') chargerJoueurs();
if (sectionName === 'parties') chargerParties();
if (sectionName === 'defis') chargerDefis();
if (sectionName === 'kills') chargerKills();
if (sectionName === 'classement') chargerListePartiesClassement();
}
async function chargerInscriptions() {
const inscriptions = await supabaseSelect('inscriptions_attente', '?statut=eq.en_attente');
let html = '<table><tr><th>Nom</th><th>Pr√©nom</th><th>Pseudo</th><th>T√©l√©phone</th><th>Actions</th></tr>';
inscriptions.forEach(inscription => {
html += `
<tr>
<td>${inscription.nom}</td>
<td>${inscription.prenom}</td>
<td>${inscription.pseudo}</td>
<td>${inscription.telephone}</td>
<td>
<button class="btn btn-success" onclick="validerInscription('${inscription.id}', '${inscription.telephone}', '${inscription.nom}', '${inscription.prenom}', '${inscription.pseudo}', '${inscription.mot_de_passe}')">‚úÖ Valider</button>
<button class="btn btn-danger" onclick="refuserInscription('${inscription.id}')">‚ùå Refuser</button>
</td>
</tr>
`;
});
html += '</table>';
document.getElementById('inscriptionsTable').innerHTML = html;
}
async function validerInscription(id, telephone, nom, prenom, pseudo, mdp) {
await supabaseInsert('joueurs', {
telephone: telephone,
nom: nom,
prenom: prenom,
pseudo: pseudo,
mot_de_passe: mdp,
statut_global: 'actif'
});
await supabaseUpdate('inscriptions_attente', { statut: 'valide' }, `?id=eq.${id}`);
alert('‚úÖ Joueur valid√© !');
chargerInscriptions();
}
async function refuserInscription(id) {
await supabaseUpdate('inscriptions_attente', { statut: 'refuse' }, `?id=eq.${id}`);
alert('‚ùå Inscription refus√©e');
chargerInscriptions();
}
async function chargerJoueurs() {
const joueurs = await supabaseSelect('joueurs');
let html = '<table><tr><th>Nom</th><th>Pr√©nom</th><th>Pseudo</th><th>T√©l√©phone</th><th>Statut</th></tr>';
joueurs.forEach(joueur => {
html += `
<tr>
<td>${joueur.nom}</td>
<td>${joueur.prenom}</td>
<td>${joueur.pseudo}</td>
<td>${joueur.telephone}</td>
<td>${joueur.statut_global}</td>
</tr>
`;
});
html += '</table>';
document.getElementById('joueursTable').innerHTML = html;
}
async function creerPartie() {
const nomPartie = document.getElementById('nomPartie').value;
if (!nomPartie) {
alert('‚ö†Ô∏è Veuillez entrer un nom de partie');
return;
}
await supabaseInsert('parties', {
nom_partie: nomPartie,
statut: 'creee'
});
alert('‚úÖ Partie cr√©√©e !');
document.getElementById('nomPartie').value = '';
chargerParties();
}
async function chargerParties() {
    const parties = await supabaseSelect('parties');
    let html = '<table><tr><th>Nom de la partie</th><th>Statut</th><th>Date</th><th>Actions</th></tr>';
    parties.forEach(partie => {
        html += `
        <tr>
            <td>${partie.nom_partie}</td>
            <td>
                ${partie.statut === 'terminee' ?
                    '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:12px;">üèÜ Termin√©e</span>' :
                    partie.statut
                }
            </td>
            <td>${new Date(partie.created_at).toLocaleDateString('fr-FR')}</td>
            <td>
                ${partie.statut === 'creee' ? `<button class="btn btn-primary" onclick="configurerPartie('${partie.id}')">‚öôÔ∏è Configurer</button>` : ''}
                ${partie.statut === 'lancee' ? `<button class="btn btn-success" onclick="voirDetailsPartie('${partie.id}', '${partie.nom_partie}')">üëÅÔ∏è Voir d√©tails</button>` : ''}
                <button class="btn btn-danger" onclick="supprimerPartie('${partie.id}', '${partie.nom_partie}')" style="margin-left: 5px;">üóëÔ∏è Supprimer</button>
            </td>
        </tr>
        `;
    });
    html += '</table>';
    document.getElementById('partiesTable').innerHTML = html;
}
async function ajouterDefi() {
const description = document.getElementById('nouveauDefi').value;
if (!description) {
alert('‚ö†Ô∏è Veuillez entrer une description');
return;
}
await supabaseInsert('defis', {
description: description
});
alert('‚úÖ D√©fi ajout√© !');
document.getElementById('nouveauDefi').value = '';
chargerDefis();
}
async function chargerDefis() {
const defis = await supabaseSelect('defis');
let html = '<table><tr><th>Description du d√©fi</th></tr>';
defis.forEach(defi => {
html += `
<tr>
<td>${defi.description}</td>
</tr>
`;
});
html += '</table>';
document.getElementById('defisTable').innerHTML = html;
}
async function chargerKills() {
const kills = await supabaseSelect('kills_en_attente', '?statut_kill=eq.conteste');
let html = '';
if (kills.length === 0) {
html = '<p>Aucun kill contest√© pour le moment.</p>';
} else {
html = '<table><tr><th>Tueur</th><th>Cible</th><th>D√©fi</th><th>Date</th><th>Actions</th></tr>';
for (const kill of kills) {
const tueur = await supabaseSelect('joueurs', `?id=eq.${kill.id_tueur}`);
const cible = await supabaseSelect('joueurs', `?id=eq.${kill.id_cible}`);
const defi = await supabaseSelect('defis', `?id=eq.${kill.id_defi}`);
if (tueur.length > 0 && cible.length > 0 && defi.length > 0) {
html += `
<tr>
<td>${tueur[0].pseudo}</td>
<td>${cible[0].pseudo}</td>
<td>${defi[0].description}</td>
<td>${new Date(kill.created_at).toLocaleDateString('fr-FR')}</td>
<td>
<button class="btn btn-success" onclick="validerKill('${kill.id}')">‚úÖ Valider</button>
<button class="btn btn-danger" onclick="invaliderKill('${kill.id}')">‚ùå Invalider</button>
</td>
</tr>
`;
}
}
html += '</table>';
}
document.getElementById('killsTable').innerHTML = html;
}
async function validerKill(idKill) {
try {
// R√©cup√©rer les infos du kill
const killData = await supabaseSelect('kills_en_attente', `?id=eq.${idKill}`);
if (killData.length === 0) {
alert('‚ùå Kill non trouv√©');
return;
}
const kill = killData[0];
// 1. Mettre √† jour le statut du kill
await supabaseUpdate('kills_en_attente', { statut_kill: 'valide' }, `?id=eq.${idKill}`);
// 2. Mettre √† jour le statut de la cible (elle est morte)
await supabaseUpdate('parties_joueurs',
{ statut_joueur: 'mort' },
`?id_joueur=eq.${kill.id_cible}&id_partie=eq.${kill.id_partie}`
);
// 3. R√©cup√©rer la cible de la victime (celle du joueur mort)
const victime = await supabaseSelect('parties_joueurs',
`?id_joueur=eq.${kill.id_cible}&id_partie=eq.${kill.id_partie}`
);
if (victime.length > 0) {
const nouvelleCible = victime[0].id_cible;
const nouveauDefi = victime[0].id_defi;
// 4. Assigner cette cible au tueur
await supabaseUpdate('parties_joueurs',
{
id_cible: nouvelleCible,
id_defi: nouveauDefi
},
`?id_joueur=eq.${kill.id_tueur}&id_partie=eq.${kill.id_partie}`
);
// 5. Mettre √† jour l'historique du tueur
const tueurData = await supabaseSelect('parties_joueurs',
`?id_joueur=eq.${kill.id_tueur}&id_partie=eq.${kill.id_partie}`
);
if (tueurData.length > 0) {
// R√©cup√©rer le pseudo de la victime
const victimeInfo = await supabaseSelect('joueurs', `?id=eq.${kill.id_cible}`);
const pseudoVictime = victimeInfo.length > 0 ? victimeInfo[0].pseudo : 'Inconnu';
let historique = tueurData[0].historique_kills || [];
historique.push({
cible: pseudoVictime,
date: new Date().toISOString()
});
await supabaseUpdate('parties_joueurs',
{ historique_kills: historique },
`?id_joueur=eq.${kill.id_tueur}&id_partie=eq.${kill.id_partie}`
);
}
}
alert('‚úÖ Kill valid√© par l\'admin ! Le joueur a √©t√© √©limin√© et le tueur a r√©cup√©r√© une nouvelle cible.');
chargerKills();
} catch (error) {
console.error('Erreur:', error);
alert('‚ùå Erreur lors de la validation du kill');
}
}
async function invaliderKill(idKill) {
try {
await supabaseUpdate('kills_en_attente', { statut_kill: 'refuse' }, `?id=eq.${idKill}`);
alert('‚ùå Kill invalid√© par l\'admin');
chargerKills();
} catch (error) {
console.error('Erreur:', error);
alert('‚ùå Erreur lors de l\'invalidation du kill');
}
}
let partieEnCours = null;
let joueursSelectionnes = [];
let boucleGeneree = [];
async function configurerPartie(idPartie) {
partieEnCours = idPartie;
const parties = await supabaseSelect('parties', `?id=eq.${idPartie}`);
document.getElementById('nomPartieConfig').textContent = `Partie : ${parties[0].nom_partie}`;
const joueurs = await supabaseSelect('joueurs', '?statut_global=eq.actif');
let html = '<div style="max-height:300px; overflow-y:auto;">';
joueurs.forEach(joueur => {
html += `
<label style="display:block; padding:10px; border:1px solid #ddd; margin-bottom:5px; cursor:pointer;">
<input type="checkbox" value="${joueur.id}" onchange="toggleJoueur(this, '${joueur.id}', '${joueur.pseudo}')">
${joueur.pseudo} (${joueur.nom} ${joueur.prenom})
</label>
`;
});
html += '</div>';
document.getElementById('listeJoueursConfig').innerHTML = html;
document.getElementById('modalConfig').style.display = 'block';
}
function toggleJoueur(checkbox, id, pseudo) {
if (checkbox.checked) {
joueursSelectionnes.push({ id, pseudo });
} else {
joueursSelectionnes = joueursSelectionnes.filter(j => j.id !== id);
}
}
async function genererBoucle() {
    if (joueursSelectionnes.length < 3) {
        alert('‚ö†Ô∏è Il faut au moins 3 joueurs pour cr√©er une partie');
        return;
    }

    // Meilleur m√©lange des joueurs (algorithme Fisher-Yates)
    function melangerTableau(tableau) {
        const result = [...tableau];
        for (let i = result.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [result[i], result[j]] = [result[j], result[i]];
        }
        return result;
    }

    // M√©langer les joueurs avec un vrai algorithme al√©atoire
    let joueursMelanges = melangerTableau(joueursSelectionnes);
    
    const defis = await supabaseSelect('defis');
    
    // M√©langer aussi les d√©fis pour plus de vari√©t√©
    let defisMelanges = melangerTableau(defis);
    
    boucleGeneree = [];
    
    for (let i = 0; i < joueursMelanges.length; i++) {
        const tueur = joueursMelanges[i];
        const cible = joueursMelanges[(i + 1) % joueursMelanges.length];
        
        // Choisir un d√©fi al√©atoire
        const defi = defisMelanges[Math.floor(Math.random() * defisMelanges.length)];
        
        boucleGeneree.push({
            tueur,
            cible,
            defi
        });
    }

    // Affichage du r√©sultat avec menus d√©roulants pour modifier les d√©fis
    let html = '<table><tr><th>Tueur</th><th>‚Üí</th><th>Cible</th><th>D√©fi</th></tr>';
    
    for (let i = 0; i < boucleGeneree.length; i++) {
        const item = boucleGeneree[i];
        html += `
        <tr>
            <td>${item.tueur.pseudo}</td>
            <td>‚Üí</td>
            <td>${item.cible.pseudo}</td>
            <td>
                <select id="defi_${i}" onchange="modifierDefi(${i}, this.value)" style="width:100%; padding:5px; border:1px solid #ddd; border-radius:3px;">
                    ${defis.map(defi => 
                        `<option value="${defi.id}" ${defi.id === item.defi.id ? 'selected' : ''}>${defi.description}</option>`
                    ).join('')}
                </select>
            </td>
        </tr>
        `;
    }
    html += '</table>';
    
    // Bouton pour re-g√©n√©rer et section de gestion des d√©fis
    html += `
    <div style="margin-top: 20px;">
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="genererBoucle()">
                üîÑ R√©g√©n√©rer la boucle
            </button>
            <button class="btn btn-success" onclick="verifierEtOptimiserDefis()">
                ‚ú® Optimiser les d√©fis
            </button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h4>üìä Statistiques des d√©fis :</h4>
            <div id="statsDefis"></div>
        </div>
    </div>
    `;
    
    document.getElementById('affichageBoucle').innerHTML = html;
    document.getElementById('boucleSection').style.display = 'block';
    // Modifier un d√©fi dans la boucle
async function modifierDefi(index, nouveauDefiId) {
    const defis = await supabaseSelect('defis');
    const nouveauDefi = defis.find(d => d.id == nouveauDefiId);
    
    if (nouveauDefi) {
        boucleGeneree[index].defi = nouveauDefi;
        afficherStatsDefis(); // Mettre √† jour les stats
    }
}
    // Afficher les statistiques
    afficherStatsDefis();
}


// Afficher les statistiques des d√©fis utilis√©s
function afficherStatsDefis() {
    const compteurDefis = {};
    const defisNonUtilises = [];
    
    // Compter les d√©fis utilis√©s
    boucleGeneree.forEach(item => {
        if (compteurDefis[item.defi.description]) {
            compteurDefis[item.defi.description]++;
        } else {
            compteurDefis[item.defi.description] = 1;
        }
    });
    
    // R√©cup√©rer tous les d√©fis pour voir lesquels ne sont pas utilis√©s
    supabaseSelect('defis').then(tousDefis => {
        const defisUtilises = boucleGeneree.map(b => b.defi.id);
        const defisLibres = tousDefis.filter(d => !defisUtilises.includes(d.id));
        
        let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
        
        // Colonne 1 : D√©fis utilis√©s
        html += '<div>';
        html += '<h5 style="color: #28a745; margin-bottom: 10px;">‚úÖ D√©fis attribu√©s :</h5>';
        for (const [defi, count] of Object.entries(compteurDefis)) {
            const couleur = count > 1 ? '#dc3545' : '#28a745';
            html += `<div style="color: ${couleur}; margin-bottom: 5px;">
                        ${defi} ${count > 1 ? `(utilis√© ${count} fois)` : ''}
                     </div>`;
        }
        html += '</div>';
        
        // Colonne 2 : D√©fis non utilis√©s
        html += '<div>';
        if (defisLibres.length > 0) {
            html += '<h5 style="color: #007bff; margin-bottom: 10px;">üí° D√©fis disponibles :</h5>';
            defisLibres.forEach(defi => {
                html += `<div style="color: #666; margin-bottom: 5px;">
                            ${defi.description}
                         </div>`;
            });
        } else {
            html += '<h5 style="color: #ffc107; margin-bottom: 10px;">‚ö†Ô∏è Tous les d√©fis sont utilis√©s</h5>';
        }
        html += '</div>';
        
        html += '</div>';
        
        // Avertissement si des d√©fis sont dupliqu√©s
        const defisDeubeles = Object.entries(compteurDefis).filter(([defi, count]) => count > 1);
        if (defisDeubeles.length > 0) {
            html += `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>‚ö†Ô∏è Attention :</strong> Certains d√©fis sont utilis√©s plusieurs fois. 
                        Utilisez le bouton "Optimiser les d√©fis" pour une r√©partition unique.
                     </div>`;
        }
        
        document.getElementById('statsDefis').innerHTML = html;
    });
}

// Optimiser automatiquement les d√©fis pour √©viter les doublons
async function verifierEtOptimiserDefis() {
    const defis = await supabaseSelect('defis');
    
    if (defis.length < boucleGeneree.length) {
        alert(`‚ö†Ô∏è Il n'y a que ${defis.length} d√©fis disponibles pour ${boucleGeneree.length} joueurs.\nCertains d√©fis seront forc√©ment dupliqu√©s.`);
    }
    
    if (!confirm('‚ú® Voulez-vous optimiser automatiquement la r√©partition des d√©fis ?\n\nCela attribuera un d√©fi unique √† chaque joueur dans la mesure du possible.')) {
        return;
    }
    
    // M√©langer les d√©fis pour une attribution al√©atoire mais optimis√©e
    const defisMelanges = [...defis].sort(() => Math.random() - 0.5);
    
    // Attribuer les d√©fis de mani√®re optimis√©e
    for (let i = 0; i < boucleGeneree.length; i++) {
        const defiIndex = i % defisMelanges.length;
        boucleGeneree[i].defi = defisMelanges[defiIndex];
    }
    
    // R√©g√©n√©rer l'affichage
    genererBoucle();
    
    alert('‚úÖ D√©fis optimis√©s ! Chaque d√©fi est maintenant utilis√© de mani√®re √©quilibr√©e.');
}
async function lancerPartie() {
if (!confirm('üöÄ √ätes-vous s√ªr de vouloir lancer la partie ? Les joueurs recevront leurs cibles.')) {
return;
}
try {
for (const item of boucleGeneree) {
await supabaseInsert('parties_joueurs', {
id_partie: partieEnCours,
id_joueur: item.tueur.id,
id_tueur: null,
id_cible: item.cible.id,
id_defi: item.defi.id,
statut_joueur: 'vivant'
});
}
await supabaseUpdate('parties',
{ statut: 'lancee' },
`?id=eq.${partieEnCours}`
);
alert('‚úÖ Partie lanc√©e avec succ√®s ! Les joueurs peuvent maintenant se connecter.');
fermerModal();
chargerParties();
} catch (error) {
console.error('Erreur:', error);
alert('‚ùå Erreur lors du lancement de la partie');
}
}
function fermerModal() {
document.getElementById('modalConfig').style.display = 'none';
partieEnCours = null;
joueursSelectionnes = [];
boucleGeneree = [];
}
// Voir les d√©tails d'une partie lanc√©e
async function voirDetailsPartie(idPartie, nomPartie) {
// Sauvegarder l'√©tat du modal
localStorage.setItem('adminModalDetailsOpen', 'true');
localStorage.setItem('adminModalDetailsPartie', idPartie);
localStorage.setItem('adminModalDetailsNom', nomPartie);
document.getElementById('nomPartieDetails').textContent = `Partie : ${nomPartie}`;
// Charger la boucle des joueurs
await chargerBouclePartie(idPartie);
// Charger les kills en attente
await chargerKillsEnAttentePartie(idPartie);
// Charger l'historique des kills - AJOUTEZ CETTE LIGNE
await chargerHistoriqueKills(idPartie);
document.getElementById('modalDetails').style.display = 'block';
}
// Charger la boucle des joueurs pour une partie
async function chargerBouclePartie(idPartie) {
    try {
        const partiesJoueurs = await supabaseSelect('parties_joueurs',
            `?id_partie=eq.${idPartie}&select=*,joueurs!parties_joueurs_id_joueur_fkey(nom,prenom,pseudo),cibles:joueurs!parties_joueurs_id_cible_fkey(nom,prenom,pseudo),defis(*)`
        );

        let html = '<table><tr><th>Tueur</th><th>‚Üí</th><th>Cible</th><th>D√©fi</th><th>Statut</th><th>Actions</th></tr>';
        partiesJoueurs.forEach(pj => {
            const tueur = pj.joueurs;
            const cible = pj.cibles;
            const defi = pj.defis;
            const statutBadge = pj.statut_joueur === 'vivant' ?
                '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:12px;font-size:12px;">‚úÖ Vivant</span>' :
                '<span style="background:#dc3545;color:white;padding:4px 8px;border-radius:12px;font-size:12px;">üíÄ Mort</span>';
            
            html += `
            <tr>
                <td>${tueur.pseudo} (${tueur.nom} ${tueur.prenom})</td>
                <td>‚Üí</td>
                <td>${cible.pseudo} (${cible.nom} ${cible.prenom})</td>
                <td>${defi.description}</td>
                <td>${statutBadge}</td>
                <td>
                    ${pj.statut_joueur === 'vivant' ? 
                        `<button class="btn btn-danger" onclick="eliminerJoueur('${pj.id_joueur}', '${idPartie}', '${tueur.pseudo}')" style="font-size:12px; padding:4px 8px;">üíÄ √âliminer</button>` 
                        : '<span style="color:#666; font-size:12px;">D√©j√† √©limin√©</span>'
                    }
                </td>
            </tr>
            `;
        });
        html += '</table>';

        // V√©rifier si la partie est termin√©e
        const joueursVivants = partiesJoueurs.filter(pj => pj.statut_joueur === 'vivant');
        if (joueursVivants.length === 1) {
            const gagnant = joueursVivants[0].joueurs;
            html += `
            <div style="background:#d4edda; border:2px solid #28a745; padding:20px; margin-top:20px; border-radius:10px; text-align:center;">
                <h3 style="color:#28a745; margin-bottom:15px;">üèÜ PARTIE TERMIN√âE ! üèÜ</h3>
                <p style="font-size:18px; margin-bottom:10px;"><strong>Gagnant : ${gagnant.pseudo}</strong></p>
                <p style="color:#666;">(${gagnant.nom} ${gagnant.prenom})</p>
                <div style="margin-top:15px; font-size:30px;">üéâ üëë üéâ</div>
            </div>
            `;
        } else if (joueursVivants.length === 0) {
            html += `
            <div style="background:#f8d7da; border:2px solid #dc3545; padding:20px; margin-top:20px; border-radius:10px; text-align:center;">
                <h3 style="color:#dc3545;">‚ö†Ô∏è ANOMALIE D√âTECT√âE</h3>
                <p>Aucun joueur vivant dans cette partie. V√©rifiez les donn√©es.</p>
            </div>
            `;
        }

        document.getElementById('boucleDetails').innerHTML = html;
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('boucleDetails').innerHTML = '<p style="color:red;">Erreur lors du chargement de la boucle</p>';
    }
}
// Charger les kills en attente pour une partie
async function chargerKillsEnAttentePartie(idPartie) {
try {
const kills = await supabaseSelect('kills_en_attente',
`?id_partie=eq.${idPartie}&statut_kill=eq.en_attente`
);
if (kills.length === 0) {
document.getElementById('killsEnAttenteDetails').innerHTML =
'<p style="color:#666;">Aucun kill en attente de validation pour cette partie.</p>';
return;
}
let html = '<table><tr><th>Tueur</th><th>Cible</th><th>D√©fi</th><th>D√©clar√© le</th><th>Actions</th></tr>';
for (const kill of kills) {
const tueur = await supabaseSelect('joueurs', `?id=eq.${kill.id_tueur}`);
const cible = await supabaseSelect('joueurs', `?id=eq.${kill.id_cible}`);
const defi = await supabaseSelect('defis', `?id=eq.${kill.id_defi}`);
if (tueur.length > 0 && cible.length > 0 && defi.length > 0) {
const dateDeclaration = new Date(kill.created_at);
const dateFormatee = dateDeclaration.toLocaleDateString('fr-FR') + ' √† ' +
dateDeclaration.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
html += `
<tr>
<td>${tueur[0].pseudo}</td>
<td>${cible[0].pseudo}</td>
<td>${defi[0].description}</td>
<td>${dateFormatee}</td>
<td>
<button class="btn btn-success" onclick="validerKillDepuisDetails('${kill.id}', '${idPartie}')">‚úÖ Valider</button>
<button class="btn btn-danger" onclick="invaliderKillDepuisDetails('${kill.id}', '${idPartie}')">‚ùå Invalider</button>
</td>
</tr>
`;
}
}
html += '</table>';
document.getElementById('killsEnAttenteDetails').innerHTML = html;
} catch (error) {
console.error('Erreur:', error);
document.getElementById('killsEnAttenteDetails').innerHTML =
'<p style="color:red;">Erreur lors du chargement des kills</p>';
}
}
// Charger l'historique des kills r√©ussis pour une partie
async function chargerHistoriqueKills(idPartie) {
    try {
        const kills = await supabaseSelect('kills_en_attente', 
            `?id_partie=eq.${idPartie}&statut_kill=neq.en_attente`
        );
        
        if (kills.length === 0) {
            document.getElementById('historiqueKillsDetails').innerHTML = 
                '<p style="color:#666;">Aucun kill termin√© pour cette partie.</p>';
            return;
        }
        
        let html = '<table><tr><th>Tueur</th><th>Victime</th><th>D√©fi</th><th>Date</th><th>Statut</th></tr>';
        
        for (const kill of kills) {
            const tueur = await supabaseSelect('joueurs', `?id=eq.${kill.id_tueur}`);
            const cible = await supabaseSelect('joueurs', `?id=eq.${kill.id_cible}`);
            const defi = await supabaseSelect('defis', `?id=eq.${kill.id_defi}`);
            
            if (tueur.length > 0 && cible.length > 0 && defi.length > 0) {
                const dateKill = new Date(kill.created_at);
                const dateFormatee = dateKill.toLocaleDateString('fr-FR');
                
                const statutBadge = kill.statut_kill === 'valide' ?
                    '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:12px;font-size:12px;">‚úÖ Valid√©</span>' :
                    '<span style="background:#dc3545;color:white;padding:4px 8px;border-radius:12px;font-size:12px;">‚ùå Refus√©</span>';
                
                html += `
                <tr>
                    <td>${tueur[0].pseudo}</td>
                    <td>${cible[0].pseudo}</td>
                    <td>${defi[0].description}</td>
                    <td>${dateFormatee}</td>
                    <td>${statutBadge}</td>
                </tr>
                `;
            }
        }
        
        html += '</table>';
        document.getElementById('historiqueKillsDetails').innerHTML = html;
        
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('historiqueKillsDetails').innerHTML = 
            '<p style="color:red;">Erreur lors du chargement de l\'historique</p>';
    }
}
// Valider un kill depuis les d√©tails de la partie
async function validerKillDepuisDetails(idKill, idPartie) {
await validerKill(idKill);
// Recharger les d√©tails de la partie
await chargerKillsEnAttentePartie(idPartie);
await chargerBouclePartie(idPartie);
}
// Invalider un kill depuis les d√©tails de la partie
async function invaliderKillDepuisDetails(idKill, idPartie) {
await invaliderKill(idKill);
// Recharger les d√©tails de la partie
await chargerKillsEnAttentePartie(idPartie);
}
// Fermer le modal des d√©tails
function fermerModalDetails() {
document.getElementById('modalDetails').style.display = 'none';
// Nettoyer le localStorage
localStorage.removeItem('adminModalDetailsOpen');
localStorage.removeItem('adminModalDetailsPartie');
localStorage.removeItem('adminModalDetailsNom');
}
// Charger la section active au d√©marrage de la page
document.addEventListener('DOMContentLoaded', function() {
const sectionActive = localStorage.getItem('adminActiveSection') || 'inscriptions';
const boutonActif = document.querySelector(`button[onclick*="${sectionActive}"]`);
if (boutonActif) {
showSection(sectionActive, boutonActif);
} else {
chargerInscriptions();
}
// V√©rifier si le modal d√©tails √©tait ouvert
const modalOuvert = localStorage.getItem('adminModalDetailsOpen');
if (modalOuvert === 'true') {
const idPartie = localStorage.getItem('adminModalDetailsPartie');
const nomPartie = localStorage.getItem('adminModalDetailsNom');
if (idPartie && nomPartie) {
setTimeout(() => {
voirDetailsPartie(idPartie, nomPartie);
}, 500); // Petit d√©lai pour laisser la page se charger
}
}
});
// Supprimer une partie
async function supprimerPartie(idPartie, nomPartie) {
    if (!confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer d√©finitivement la partie "${nomPartie}" ?\n\n‚ö†Ô∏è Cette action supprimera :\n- La partie\n- Tous les joueurs associ√©s\n- Tous les kills de cette partie\n\nCette action est irr√©versible !`)) {
        return;
    }

    try {
        // Supprimer d'abord les kills associ√©s
        await supabaseDelete('kills_en_attente', `?id_partie=eq.${idPartie}`);
        
        // Supprimer les joueurs de la partie
        await supabaseDelete('parties_joueurs', `?id_partie=eq.${idPartie}`);
        
        // Supprimer la partie
        await supabaseDelete('parties', `?id=eq.${idPartie}`);
        
        alert('‚úÖ Partie supprim√©e avec succ√®s !');
        chargerParties();
    } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        alert('‚ùå Erreur lors de la suppression de la partie');
    }
}

// √âliminer un joueur manuellement
async function eliminerJoueur(idJoueur, idPartie, pseudoJoueur) {
    if (!confirm(`üíÄ √ätes-vous s√ªr de vouloir √©liminer "${pseudoJoueur}" de la partie ?\n\nLe joueur sera marqu√© comme mort et sa cible sera transf√©r√©e √† son tueur.`)) {
        return;
    }

    try {
        // 1. R√©cup√©rer les infos du joueur √† √©liminer
        const joueurAEliminer = await supabaseSelect('parties_joueurs', 
            `?id_joueur=eq.${idJoueur}&id_partie=eq.${idPartie}`
        );
        
        if (joueurAEliminer.length === 0) {
            alert('‚ùå Joueur non trouv√© dans cette partie');
            return;
        }

        const cibleDuJoueurElimine = joueurAEliminer[0].id_cible;
        const defiDuJoueurElimine = joueurAEliminer[0].id_defi;

        // 2. Trouver qui avait ce joueur comme cible (son tueur)
        const tueurDuJoueur = await supabaseSelect('parties_joueurs',
            `?id_cible=eq.${idJoueur}&id_partie=eq.${idPartie}&statut_joueur=eq.vivant`
        );

        // 3. Marquer le joueur comme mort
        await supabaseUpdate('parties_joueurs',
            { statut_joueur: 'mort' },
            `?id_joueur=eq.${idJoueur}&id_partie=eq.${idPartie}`
        );

        // 4. Si le joueur avait un tueur, lui donner la cible du joueur √©limin√©
        if (tueurDuJoueur.length > 0) {
            await supabaseUpdate('parties_joueurs',
                { 
                    id_cible: cibleDuJoueurElimine,
                    id_defi: defiDuJoueurElimine
                },
                `?id_joueur=eq.${tueurDuJoueur[0].id_joueur}&id_partie=eq.${idPartie}`
            );

            // 5. Mettre √† jour l'historique du tueur
            let historique = tueurDuJoueur[0].historique_kills || [];
            historique.push({
                cible: pseudoJoueur,
                date: new Date().toISOString(),
                type: 'elimination_admin'
            });

            await supabaseUpdate('parties_joueurs',
                { historique_kills: historique },
                `?id_joueur=eq.${tueurDuJoueur[0].id_joueur}&id_partie=eq.${idPartie}`
            );
        }

        // 6. V√©rifier si la partie est termin√©e
        const joueursVivants = await supabaseSelect('parties_joueurs',
            `?id_partie=eq.${idPartie}&statut_joueur=eq.vivant`
        );

        if (joueursVivants.length === 1) {
            // Marquer la partie comme termin√©e
            await supabaseUpdate('parties',
                { statut: 'terminee' },
                `?id=eq.${idPartie}`
            );
        }

        alert(`‚úÖ ${pseudoJoueur} a √©t√© √©limin√© de la partie !`);
        
        // Recharger les d√©tails de la partie
        await chargerBouclePartie(idPartie);

    } catch (error) {
        console.error('Erreur lors de l\'√©limination:', error);
        alert('‚ùå Erreur lors de l\'√©limination du joueur');
    }
}
</script>
</body>
</html>
