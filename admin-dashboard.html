<!DOCTYPE html>
          <tr>
            <td>${joueur.nom}</td>
            <td>${joueur.prenom}</td>
            <td>${joueur.pseudo}</td>
            <td>${joueur.telephone}</td>
            <td>${joueur.statut_global}</td>
          </tr>
        `;
      });
      html += '</table>';
      document.getElementById('joueursTable').innerHTML = html;
    }

    async function creerPartie() {
      const nomPartie = document.getElementById('nomPartie').value;
      if (!nomPartie) {
        alert('‚ö†Ô∏è Veuillez entrer un nom de partie');
        return;
      }
      await supabaseInsert('parties', {
        nom_partie: nomPartie,
        statut: 'creee'
      });
      alert('‚úÖ Partie cr√©√©e !');
      document.getElementById('nomPartie').value = '';
      chargerParties();
    }

    async function chargerParties() {
      const parties = await supabaseSelect('parties');
      let html = '<table><tr><th>Nom de la partie</th><th>Statut</th><th>Date</th><th>Actions</th></tr>';
      parties.forEach(partie => {
        html += `
          <tr>
            <td>${partie.nom_partie}</td>
            <td>
              ${partie.statut === 'terminee' ?
                '<span style="background:#28a745;color:white;padding:4px 8px;border-radius:12px;">üèÜ Termin√©e</span>' :
                partie.statut
              }
            </td>
            <td>${new Date(partie.created_at).toLocaleDateString('fr-FR')}</td>
            <td>
              ${partie.statut === 'creee' ? `<button class="btn btn-primary" onclick="configurerPartie('${partie.id}')">‚öôÔ∏è Configurer</button>` : ''}
              ${partie.statut === 'lancee' || partie.statut === 'terminee' ? `<button class="btn btn-success" onclick="voirDetailsPartie('${partie.id}', '${partie.nom_partie}')">üëÅÔ∏è Voir d√©tails</button>` : ''}
            </td>
          </tr>
        `;
      });
      html += '</table>';
      document.getElementById('partiesTable').innerHTML = html;
    }

    async function ajouterDefi() {
      const description = document.getElementById('nouveauDefi').value;
      if (!description) {
        alert('‚ö†Ô∏è Veuillez entrer une description');
        return;
      }
      await supabaseInsert('defis', {
        description: description
      });
      alert('‚úÖ D√©fi ajout√© !');
      document.getElementById('nouveauDefi').value = '';
      chargerDefis();
    }
        async function chargerDefis() {
      const defis = await supabaseSelect('defis');
      let html = '<table><tr><th>Description du d√©fi</th></tr>';
      defis.forEach(defi => {
        html += `
          <tr>
            <td>${defi.description}</td>
          </tr>
        `;
      });
      html += '</table>';
      document.getElementById('defisTable').innerHTML = html;
    }

    async function chargerKills() {
      const kills = await supabaseSelect('kills_en_attente', '?statut_kill=eq.conteste');
      let html = '';
      if (kills.length === 0) {
        html = '<p>Aucun kill contest√© pour le moment.</p>';
      } else {
        html = '<table><tr><th>Tueur</th><th>Cible</th><th>D√©fi</th><th>Date</th><th>Actions</th></tr>';
        for (const kill of kills) {
          const tueur = await supabaseSelect('joueurs', `?id=eq.${kill.id_tueur}`);
          const cible = await supabaseSelect('joueurs', `?id=eq.${kill.id_cible}`);
          const defi = await supabaseSelect('defis', `?id=eq.${kill.id_defi}`);
          if (tueur.length > 0 && cible.length > 0 && defi.length > 0) {
            html += `
              <tr>
                <td>${tueur[0].pseudo}</td>
                <td>${cible[0].pseudo}</td>
                <td>${defi[0].description}</td>
                <td>${new Date(kill.created_at).toLocaleDateString('fr-FR')}</td>
                <td>
                  <button class="btn btn-success" onclick="validerKill('${kill.id}')">‚úÖ Valider</button>
                  <button class="btn btn-danger" onclick="invaliderKill('${kill.id}')">‚ùå Invalider</button>
                </td>
              </tr>
            `;
          }
        }
        html += '</table>';
      }
      document.getElementById('killsTable').innerHTML = html;
    }

    async function validerKill(idKill) {
      try {
        const killData = await supabaseSelect('kills_en_attente', `?id=eq.${idKill}`);
        if (killData.length === 0) {
          alert('‚ùå Kill non trouv√©');
          return;
        }
        const kill = killData[0];
        await supabaseUpdate('kills_en_attente', { statut_kill: 'valide' }, `?id=eq.${idKill}`);
        await supabaseUpdate('parties_joueurs',
          { statut_joueur: 'mort' },
          `?id_joueur=eq.${kill.id_cible}&id_partie=eq.${kill.id_partie}`
        );
        const victime = await supabaseSelect('parties_joueurs',
          `?id_joueur=eq.${kill.id_cible}&id_partie=eq.${kill.id_partie}`
        );
        if (victime.length > 0) {
          const nouvelleCible = victime[0].id_cible;
          const nouveauDefi = victime[0].id_defi;
          await supabaseUpdate('parties_joueurs',
            {
              id_cible: nouvelleCible,
              id_defi: nouveauDefi
            },
            `?id_joueur=eq.${kill.id_tueur}&id_partie=eq.${kill.id_partie}`
          );
          const tueurData = await supabaseSelect('parties_joueurs',
            `?id_joueur=eq.${kill.id_tueur}&id_partie=eq.${kill.id_partie}`
          );
          if (tueurData.length > 0) {
            const victimeInfo = await supabaseSelect('joueurs', `?id=eq.${kill.id_cible}`);
            const pseudoVictime = victimeInfo.length > 0 ? victimeInfo[0].pseudo : 'Inconnu';
            let historique = tueurData[0].historique_kills || [];
            historique.push({
              cible: pseudoVictime,
              date: new Date().toISOString()
            });
            await supabaseUpdate('parties_joueurs',
              { historique_kills: historique },
              `?id_joueur=eq.${kill.id_tueur}&id_partie=eq.${kill.id_partie}`
            );
          }
        }
                               dateDeclaration.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
            html += `
              <tr>
                <td>${tueur[0].pseudo}</td>
                <td>${cible[0].pseudo}</td>
                <td>${defi[0].description}</td>
                <td>${dateFormatee}</td>
                <td>
                  <button class="btn btn-success" onclick="validerKillDepuisDetails('${kill.id}', '${idPartie}')">‚úÖ Valider</button>
                  <button class="btn btn-danger" onclick="invaliderKillDepuisDetails('${kill.id}', '${idPartie}')">‚ùå Invalider</button>
                </td>
              </tr>
            `;
          }
        }
        html += '</table>';
        document.getElementById('killsEnAttenteDetails').innerHTML = html;
      } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('killsEnAttenteDetails').innerHTML =
          '<p style="color:red;">Erreur lors du chargement des kills</p>';
      }
    }

    async function chargerHistoriqueKills(idPartie) {
      try {
        const killsReussis = await supabaseSelect('kills_en_attente',
          `?id_partie=eq.${idPartie}&or=(statut_kill.eq.valide,statut_kill.eq.accepte)&order=created_at.desc`
        );
        if (killsReussis.length === 0) {
          document.getElementById('historiqueKillsDetails').innerHTML =
            '<p style="color:#666;">Aucun kill r√©ussi pour le moment dans cette partie.</p>';
          return;
        }
        const killsParJoueur = {};
        for (const kill of killsReussis) {
          const tueur = await supabaseSelect('joueurs', `?id=eq.${kill.id_tueur}`);
          const cible = await supabaseSelect('joueurs', `?id=eq.${kill.id_cible}`);
          const defi = await supabaseSelect('defis', `?id=eq.${kill.id_defi}`);
          if (tueur.length > 0 && cible.length > 0 && defi.length > 0) {
            const tueurData = tueur[0];
            const cibleData = cible[0];
            const defiData = defi[0];
            if (!killsParJoueur[tueurData.pseudo]) {
              killsParJoueur[tueurData.pseudo] = {
                nom: `${tueurData.nom} ${tueurData.prenom}`,
                kills: []
              };
            }
            const dateKill = new Date(kill.created_at);
            const dateFormatee = dateKill.toLocaleDateString('fr-FR') + ' √† ' +
                               dateKill.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
            killsParJoueur[tueurData.pseudo].kills.push({
              cible: cibleData.pseudo,
              cibleNomComplet: `${cibleData.nom} ${cibleData.prenom}`,
              defi: defiData.description,
              date: dateFormatee,
              statut: kill.statut_kill
            });
          }
        }
        let html = '';
        Object.keys(killsParJoueur).forEach(pseudo => {
          const joueurData = killsParJoueur[pseudo];
          const nbKills = joueurData.kills.length;
          html += `
            <div style="background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; margin-bottom:20px; padding:15px;">
              <h4 style="color:#495057; margin-bottom:15px;">
                üéØ ${pseudo} (${joueurData.nom}) - ${nbKills} kill${nbKills > 1 ? 's' : ''}
              </h4>
              <div style="max-height:200px; overflow-y:auto;">
                <table style="width:100%; font-size:14px;">
                  <tr style="background:#e9ecef;">
                    <th style="padding:8px;">Victime</th>
                    <th style="padding:8px;">D√©fi</th>
                    <th style="padding:8px;">Date</th>
                    <th style="padding:8px;">Statut</th>
                  </tr>
          `;
          joueurData.kills.forEach(kill => {
            const statutBadge = kill.statut === 'valide' ?
              '<span style="background:#007bff;color:white;padding:2px 6px;border-radius:8px;font-size:11px;">Admin</span>' :
              '<span style="background:#28a745;color:white;padding:2px 6px;border-radius:8px;font-size:11px;">Accept√©</span>';
            html += `
              <tr>
                <td style="padding:8px;">${kill.cible} <small style="color:#666;">(${kill.cibleNomComplet})</small></td>
                <td style="padding:8px;"><small>${kill.defi}</small></td>
                <td style="padding:8px;"><small>${kill.date}</small></td>
                <td style="padding:8px;">${statutBadge}</td>
              </tr>
            `;
          });
                </html>
