<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Killer Game</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .nav {
      background: white;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .nav button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #f5576c;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .nav button:hover {
      background: #e04455;
    }
    
    .nav button.active {
      background: #333;
    }
    
    .content {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .section {
      display: none;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .section.active {
      display: block;
    }
    
    h2 {
      color: #f5576c;
      margin-bottom: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background: #f5576c;
      color: white;
    }
    
    tr:hover {
      background: #f9f9f9;
    }
    
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 5px;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- V√©rification de la connexion admin -->
  <script>
    if (localStorage.getItem('isAdmin') !== 'true') {
      window.location.href = 'admin-login.html';
    }
  </script>

  <div class="header">
    <h1>üéØ Admin Dashboard - Killer Game</h1>
    <p>G√©rez vos parties et joueurs</p>
  </div>
  
  <div class="nav">
    <button onclick="showSection('inscriptions')" class="active">üìù Inscriptions</button>
    <button onclick="showSection('joueurs')">üë• Joueurs</button>
    <button onclick="showSection('parties')">üéÆ Parties</button>
    <button onclick="showSection('defis')">üí° D√©fis</button>
    <button onclick="showSection('kills')">‚öîÔ∏è Kills</button>
  </div>
  
  <div class="content">
    <!-- Section Inscriptions -->
    <div id="inscriptions" class="section active">
      <h2>üìù Inscriptions en attente</h2>
      <div id="inscriptionsTable"></div>
    </div>
    
    <!-- Section Joueurs -->
    <div id="joueurs" class="section">
      <h2>üë• Liste des joueurs valid√©s</h2>
      <div id="joueursTable"></div>
    </div>
    
    <!-- Section Parties -->
    <div id="parties" class="section">
      <h2>üéÆ Gestion des parties</h2>
      
      <div style="margin-bottom: 30px;">
        <h3>Cr√©er une nouvelle partie</h3>
        <div class="form-group">
          <label>Nom de la partie</label>
          <input type="text" id="nomPartie" placeholder="Ex: Partie de No√´l 2024">
        </div>
        <button class="btn btn-primary" onclick="creerPartie()">Cr√©er la partie</button>
      </div>
      
      <div id="partiesTable"></div>
    </div>
    
    <!-- Section D√©fis -->
    <div id="defis" class="section">
      <h2>üí° Gestion des d√©fis</h2>
      
      <div style="margin-bottom: 30px;">
        <h3>Ajouter un nouveau d√©fi</h3>
        <div class="form-group">
          <label>Description du d√©fi</label>
          <input type="text" id="nouveauDefi" placeholder="Ex: Faire un high-five √† votre cible">
        </div>
        <button class="btn btn-primary" onclick="ajouterDefi()">Ajouter le d√©fi</button>
      </div>
      
      <div id="defisTable"></div>
    </div>
    
    <!-- Section Kills -->
    <div id="kills" class="section">
      <h2>‚öîÔ∏è Kills contest√©s</h2>
      <div id="killsTable"></div>
    </div>
  </div>

  <script src="supabaseClient.js"></script>
  <script>
    // Fonction pour changer de section
    function showSection(sectionName) {
      // Masquer toutes les sections
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      
      // Afficher la section demand√©e
      document.getElementById(sectionName).classList.add('active');
      event.target.classList.add('active');
      
      // Charger les donn√©es de la section
      if (sectionName === 'inscriptions') chargerInscriptions();
      if (sectionName === 'joueurs') chargerJoueurs();
      if (sectionName === 'parties') chargerParties();
      if (sectionName === 'defis') chargerDefis();
      if (sectionName === 'kills') chargerKills();
    }
    
    // GESTION DES INSCRIPTIONS
    async function chargerInscriptions() {
      const inscriptions = await supabaseSelect('inscriptions_attente', '?statut=eq.en_attente');
      
      let html = '<table><tr><th>Nom</th><th>Pr√©nom</th><th>Pseudo</th><th>T√©l√©phone</th><th>Actions</th></tr>';
      
      inscriptions.forEach(inscription => {
        html += `
          <tr>
            <td>${inscription.nom}</td>
            <td>${inscription.prenom}</td>
            <td>${inscription.pseudo}</td>
            <td>${inscription.telephone}</td>
            <td>
              <button class="btn btn-success" onclick="validerInscription('${inscription.id}', '${inscription.telephone}', '${inscription.nom}', '${inscription.prenom}', '${inscription.pseudo}', '${inscription.mot_de_passe}')">‚úÖ Valider</button>
              <button class="btn btn-danger" onclick="refuserInscription('${inscription.id}')">‚ùå Refuser</button>
            </td>
          </tr>
        `;
      });
      
      html += '</table>';
      document.getElementById('inscriptionsTable').innerHTML = html;
    }
    
    async function validerInscription(id, telephone, nom, prenom, pseudo, mdp) {
      // Ajouter le joueur dans la table joueurs
      await supabaseInsert('joueurs', {
        telephone: telephone,
        nom: nom,
        prenom: prenom,
        pseudo: pseudo,
        mot_de_passe: mdp,
        statut_global: 'actif'
      });
      
      // Mettre √† jour le statut de l'inscription
      await supabaseUpdate('inscriptions_attente', { statut: 'valide' }, `?id=eq.${id}`);
      
      alert('‚úÖ Joueur valid√© !');
      chargerInscriptions();
    }
    
    async function refuserInscription(id) {
      await supabaseUpdate('inscriptions_attente', { statut: 'refuse' }, `?id=eq.${id}`);
      alert('‚ùå Inscription refus√©e');
      chargerInscriptions();
    }
    
    // GESTION DES JOUEURS
    async function chargerJoueurs() {
      const joueurs = await supabaseSelect('joueurs');
      
      let html = '<table><tr><th>Nom</th><th>Pr√©nom</th><th>Pseudo</th><th>T√©l√©phone</th><th>Statut</th></tr>';
      
      joueurs.forEach(joueur => {
        html += `
          <tr>
            <td>${joueur.nom}</td>
            <td>${joueur.prenom}</td>
            <td>${joueur.pseudo}</td>
            <td>${joueur.telephone}</td>
            <td>${joueur.statut_global}</td>
          </tr>
        `;
      });
      
      html += '</table>';
      document.getElementById('joueursTable').innerHTML = html;
    }
    
    // GESTION DES PARTIES
    async function creerPartie() {
      const nomPartie = document.getElementById('nomPartie').value;
      
      if (!nomPartie) {
        alert('‚ö†Ô∏è Veuillez entrer un nom de partie');
        return;
      }
      
      await supabaseInsert('parties', {
        nom_partie: nomPartie,
        statut: 'creee'
      });
      
      alert('‚úÖ Partie cr√©√©e !');
      document.getElementById('nomPartie').value = '';
      chargerParties();
    }
    
    async function chargerParties() {
      const parties = await supabaseSelect('parties');
      
      let html = '<table><tr><th>Nom de la partie</th><th>Statut</th><th>Date</th><th>Actions</th></tr>';
      
      parties.forEach(partie => {
        html += `
          <tr>
            <td>${partie.nom_partie}</td>
            <td>${partie.statut}</td>
            <td>${new Date(partie.created_at).toLocaleDateString('fr-FR')}</td>
            <td>
              ${partie.statut === 'creee' ? `<button class="btn btn-primary" onclick="configurerPartie('${partie.id}')">‚öôÔ∏è Configurer</button>` : ''}
            </td>
          </tr>
        `;
      });
      
      html += '</table>';
      document.getElementById('partiesTable').innerHTML = html;
    }
    
    function configurerPartie(idPartie) {
      alert('üéÆ Configuration de partie (√† d√©velopper dans l\'√©tape 5)');
      // Cette fonctionnalit√© sera d√©velopp√©e dans l'√©tape 5
    }
    
    // GESTION DES D√âFIS
    async function ajouterDefi() {
      const description = document.getElementById('nouveauDefi').value;
      
      if (!description) {
        alert('‚ö†Ô∏è Veuillez entrer une description');
        return;
      }
      
      await supabaseInsert('defis', {
        description: description
      });
      
      alert('‚úÖ D√©fi ajout√© !');
      document.getElementById('nouveauDefi').value = '';
      chargerDefis();
    }
    
    async function chargerDefis() {
      const defis = await supabaseSelect('defis');
      
      let html = '<table><tr><th>Description du d√©fi</th></tr>';
      
      defis.forEach(defi => {
        html += `
          <tr>
            <td>${defi.description}</td>
          </tr>
        `;
      });
      
      html += '</table>';
      document.getElementById('defisTable').innerHTML = html;
    }
    
    // GESTION DES KILLS
    async function chargerKills() {
      const kills = await supabaseSelect('kills_en_attente', '?statut_kill=eq.conteste');
      
      let html = '<table><tr><th>Tueur</th><th>Cible</th><th>D√©fi</th><th>Date</th><th>Actions</th></tr>';
      
      if (kills.length === 0) {
        html = '<p>Aucun kill contest√© pour le moment.</p>';
      } else {
        for (const kill of kills) {
          // R√©cup√©rer les infos du tueur
          const tueur = await supabaseSelect('joueurs', `?id=eq.${kill.id_tueur}`);
          // R√©cup√©rer les infos de la cible
          const cible = await supabaseSelect('joueurs', `?id=eq.${kill.id_cible}`);
          // R√©cup√©rer le d√©fi
          const defi = await supabaseSelect('defis', `?id=eq.${kill.id_defi}`);
          
          html += `
            <tr>
              <td>${tueur[0].pseudo}</td>
              <td>${cible[0].pseudo}</td>
              <td>${defi[0].description}</td>
              <td>${new Date(kill.created_at).toLocaleDateString('fr-FR')}</td>
              <td>
                <button class="btn btn-success" onclick="validerKill('${kill.id}')">‚úÖ Valider</button>
                <button class="btn btn-danger" onclick="invaliderKill('${kill.id}')">‚ùå Invalider</button>
              </td>
            </tr>
          `;
        }
        html += '</table>';
      }
      
      document.getElementById('killsTable').innerHTML = html;
    }
    
    async function validerKill(idKill) {
      await supabaseUpdate('kills_en_attente', { statut_kill: 'valide' }, `?id=eq.${idKill}`);
      alert('‚úÖ Kill valid√© par l\'admin !');
      chargerKills();
      // TODO: Mettre √† jour le statut du joueur tu√© et assigner nouvelle cible
    }
    
    async function invaliderKill(idKill) {
      await supabaseUpdate('kills_en_attente', { statut_kill: 'refuse' }, `?id=eq.${idKill}`);
      alert('‚ùå Kill invalid√©');
      chargerKills();
    }
    
    // Charger les inscriptions au d√©marrage
    chargerInscriptions();
  </script>
<!-- Modal de configuration de partie -->
<div id="modalConfig" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000;">
  <div style="background:white; max-width:800px; margin:50px auto; padding:30px; border-radius:10px; max-height:80vh; overflow-y:auto;">
    <h2>‚öôÔ∏è Configuration de la partie</h2>
    <p id="nomPartieConfig" style="color:#666; margin-bottom:20px;"></p>
    
    <h3>1Ô∏è‚É£ S√©lectionner les joueurs</h3>
    <div id="listeJoueursConfig"></div>
    
    <button class="btn btn-primary" onclick="genererBoucle()" style="margin-top:20px;">
      üîÑ G√©n√©rer la boucle Tueur/Cible
    </button>
    
    <div id="boucleSection" style="display:none; margin-top:30px;">
      <h3>2Ô∏è‚É£ Boucle Tueur ‚Üí Cible ‚Üí D√©fi</h3>
      <div id="affichageBoucle"></div>
      
      <button class="btn btn-success" onclick="lancerPartie()" style="margin-top:20px;">
        üöÄ Lancer la partie !
      </button>
    </div>
    
    <button class="btn btn-danger" onclick="fermerModal()" style="margin-top:20px;">
      ‚ùå Fermer
    </button>
  </div>
</div>

<script>
  let partieEnCours = null;
  let joueursSelectionnes = [];
  let boucleGeneree = [];
  
  async function configurerPartie(idPartie) {
    partieEnCours = idPartie;
    
    // R√©cup√©rer les infos de la partie
    const parties = await supabaseSelect('parties', `?id=eq.${idPartie}`);
    document.getElementById('nomPartieConfig').textContent = `Partie : ${parties[0].nom_partie}`;
    
    // R√©cup√©rer tous les joueurs
    const joueurs = await supabaseSelect('joueurs', '?statut_global=eq.actif');
    
    let html = '<div style="max-height:300px; overflow-y:auto;">';
    joueurs.forEach(joueur => {
      html += `
        <label style="display:block; padding:10px; border:1px solid #ddd; margin-bottom:5px; cursor:pointer;">
          <input type="checkbox" value="${joueur.id}" onchange="toggleJoueur(this, '${joueur.id}', '${joueur.pseudo}')">
          ${joueur.pseudo} (${joueur.nom} ${joueur.prenom})
        </label>
      `;
    });
    html += '</div>';
    
    document.getElementById('listeJoueursConfig').innerHTML = html;
    document.getElementById('modalConfig').style.display = 'block';
  }
  
  function toggleJoueur(checkbox, id, pseudo) {
    if (checkbox.checked) {
      joueursSelectionnes.push({ id, pseudo });
    } else {
      joueursSelectionnes = joueursSelectionnes.filter(j => j.id !== id);
    }
  }
  
  async function genererBoucle() {
    if (joueursSelectionnes.length < 3) {
      alert('‚ö†Ô∏è Il faut au moins 3 joueurs pour cr√©er une partie');
      return;
    }
    
    // M√©langer les joueurs
    let joueursMelanges = [...joueursSelectionnes].sort(() => Math.random() - 0.5);
    
    // R√©cup√©rer tous les d√©fis
    const defis = await supabaseSelect('defis');
    
    // Cr√©er la boucle
    boucleGeneree = [];
    for (let i = 0; i < joueursMelanges.length; i++) {
      const tueur = joueursMelanges[i];
      const cible = joueursMelanges[(i + 1) % joueursMelanges.length];
      const defi = defis[Math.floor(Math.random() * defis.length)];
      
      boucleGeneree.push({
        tueur,
        cible,
        defi
      });
    }
    
    // Afficher la boucle
    let html = '<table><tr><th>Tueur</th><th>‚Üí</th><th>Cible</th><th>D√©fi</th></tr>';
    boucleGeneree.forEach(item => {
      html += `
        <tr>
          <td>${item.tueur.pseudo}</td>
          <td>‚Üí</td>
          <td>${item.cible.pseudo}</td>
          <td>${item.defi.description}</td>
        </tr>
      `;
    });
    html += '</table>';
    
    document.getElementById('affichageBoucle').innerHTML = html;
    document.getElementById('boucleSection').style.display = 'block';
  }
  
async function lancerPartie() {
    if (!confirm('üöÄ √ätes-vous s√ªr de vouloir lancer la partie ? Les joueurs recevront leurs cibles.')) {
      return;
    }
    
    try {
      // 1. Ins√©rer tous les joueurs dans parties_joueurs avec leurs assignations
      for (const item of boucleGeneree) {
        await supabaseInsert('parties_joueurs', {
          id_partie: partieEnCours,
          id_joueur: item.tueur.id,
          id_tueur: null, // Sera rempli plus tard si n√©cessaire
          id_cible: item.cible.id,
          id_defi: item.defi.id,
          statut_joueur: 'vivant'
        });
      }
      
      // 2. Mettre √† jour le statut de la partie
      await supabaseUpdate('parties', 
        { statut: 'lancee' }, 
        `?id=eq.${partieEnCours}`
      );
      
      alert('‚úÖ Partie lanc√©e avec succ√®s ! Les joueurs peuvent maintenant se connecter.');
      
      // Fermer le modal et recharger
      fermerModal();
      chargerParties();
      
    } catch (error) {
      console.error('Erreur:', error);
      alert('‚ùå Erreur lors du lancement de la partie');
    }
  }
  
  function fermerModal() {
    document.getElementById('modalConfig').style.display = 'none';
    joueursSelectionnes = [];
    boucleGeneree = [];
    partieEnCours = null;
  }
</script>
</body>
</html>


                                         
